---
title: "NMRdf_markdown"
author: "Crystal R Musser (CRM)"
date: "`r Sys.Date()`"
output: word_document
---
# NMR Assay: Data Frame Curation
## Script pre-req's: 
Following Analyte Standard Curve generation, nicotine metabolite serum concentration algorithm, LC-MS/MS QC, NMR calculation & QC
## Script purpose:
pull together QC'd survey data, QC'd nicotine metabolite concentration data, and any other outstanding relevant EHR data.
## Script output:
Two data frames, one containing cleaned-up variables upon committee consensus and the other joiing all raw data in addition to consensus variables.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("/Users/musserc/NicotineMetabolomics_project")

#if(!"dplyr" %in% installed.packages()) install.packages("dplyr")
library(readr) # Used Tidyverse:readr library to read multiple raw data .csv files into a single data frame
library(readxl) # Used Tidyverse:readxl library to raw survey data and data dictionary .xlsx files
library(stringr) #Used the stringr package to extract the middle 4-6 integer values from a string using regular expressions in R
library(dplyr) #removed duplicate rows from a data frame in R using the dplyr package, which provides the distinct function.

```

## Dataframe instantiation: t_allSamplesMetabolites 
It contains all 6 metabolite concentration calculated values, per each of 824 unique sample IDs
### primary key: "idNo"
### key value: "logNMR"

```{r df_instantiate}
t_calcConcData <- read.csv("v6RawData_combined.csv", header=TRUE) #per 'SampID' grab 'Analyte', 'Valid', 'CalcConc',
t_rawSurveyData  <- read_excel("phase2survey_rawData.xlsx") ##
t_otherSurveyData  <- read_excel("SHSII_HPlasma_ConfirmInventory_Out_2022.03.29_FULL_INVENTORY_withDemographics.xlsx")

t_allSamplesMetabolites <- data.frame( # new df, indexed by by idNo, with columns:
  idNo = numeric(),
  logNMR = numeric(),
  NMRcalc = numeric(),
  ExpSet = character(),
  COTconc = numeric(),
  tHCconc = numeric(),
  NICconc = numeric(),
  COconc = numeric(),
  NOconc = numeric(),
  NORNconc = numeric()
)
```

## Nomalize naming convention between input data sets
Uses regular expressions to extract the 6-digit "idNo" from the superfluous, inconsistent addition of ".d" suffixes or "SHS-" prefixes between the different input files.

### Note: I am currently removing duplicate metabolite data for simplicity.  But these are likely re-run values (ie they may need to override na values from the run before)
```{r normalizeInputs}
# Normalize naming convention
t_funk <- data.frame()
for (each in 1:nrow(t_calcConcData)) { #5327
  extracted_digits <- str_extract(t_calcConcData$SampleID[each], "\\d{4,6}")  # extract sample id using regex:str_extract to extract the middle 4-6 digits
  if (!is.na(extracted_digits)) {                      
    t_allSamplesMetabolites <- rbind(t_allSamplesMetabolites, list(
      idNo = as.numeric(extracted_digits),
      ExpSet = NA,  
      NMRcalc = NA,
      COTconc = NA,
      tHCconc = NA,
      NICconc = NA,
      COconc = NA,
      NOconc = NA,
      NORNconc = NA)    )
  } else {
    t_funk <- rbind(t_funk,each)
    print("NOT named right???")
  }
  print(paste(t_calcConcData$SampleID[each], "extracted: ", extracted_digits)) # Print the result. 
}
#Remove duplicates by keeping the first occurrence of each set of duplicates in the data frame, and remove the subsequent ones.
t_allSamplesMetabolites <- t_allSamplesMetabolites[!duplicated(t_allSamplesMetabolites), ]
# Whats the difference between survey data and LC/MS data? -> survey doesn't have BW controls, only: #3955,5829,2720,3348
diff_dfs <- anti_join(t_allSamplesMetabolites, t_rawSurveyData, by = c("idNo" = "IDNO"))
```

## Add experimental metabolite data to working data frame: "t_calcConcData" in to "t_allSamplesMetabolites"
There are 10 separate experiments, which I've tagged as A-J for simplicity.  

### Note: Experimental raw data files are currently stubbed-in as hard code, I will need to change this to allow for pipeline adaptability/scalability.
```{r addExpData}
# Add experimental date sets by labeling each "Set" appropriately in the raw LC/MS-MS dataset with exp. dates associated to origin file naming convention.
t_calcConcData[1:324,"Set"] <- "A"      #"OUTPUT_12.13.22.csv"
t_calcConcData[325:1386,"Set"] <- "B"   #"OUTPUT_01.27.23.csv"
t_calcConcData[1387:1908,"Set"] <- "C"  #"OUTPUT_02.14.23.csv"
t_calcConcData[1909:2430,"Set"] <- "D"  #"OUTPUT_2.28.23.csv"
t_calcConcData[2431:2970,"Set"] <- "E"  #"OUTPUT_3.06.23.csv"
t_calcConcData[2971:3492,"Set"] <- "F"  # "OUTPUT_3.14.23.csv"
t_calcConcData[3493:4014,"Set"] <- "G"  # "OUTPUT_3.17.23.csv"
t_calcConcData[4015:4536,"Set"] <- "H"  # "OUTPUT_3.23.23.csv"
t_calcConcData[4537:5058,"Set"] <- "I"  # "OUTPUT_4.11.23.csv"
t_calcConcData[5059:5532,"Set"] <- "J"  # "OUTPUT_4.18.23.csv"

# Add data from LC/MS-MS raw analyte concentration data
# For each of the valid samples to be anlayzed, find that sample's object, set it's validity flag to true, set the sample's experimentally determined  plasma metabolite concentration values, and add to a working object list for analysis
#  Check if there is any index in the vector of names from l_validSamples that matches the name of the current sample (foundSamp_inList[[1]]@name). If there is a match, it means the sample is already in the list, and the condition will be TRUE. Otherwise, it will be FALSE.
for (each in 1:nrow(t_calcConcData)) { #5327
  extracted_digits <- str_extract(t_calcConcData$SampleID[each],"\\d{4,6}")     #extract sample id using regex:str_extract to extract the middle 4-6 digits
  this_Analyte <- t_calcConcData[each, "Analyte"]
  this_AnalyteValue <- t_calcConcData[each,"CalcConc"]
  this_ValidAnalyte <- t_calcConcData[each,"Valid"]
  this_Set <- t_calcConcData[each,"Set"]
  if (this_ValidAnalyte==FALSE){
    print(paste("extracted",extracted_digits,"\t",this_Analyte,"\t",this_AnalyteValue,"\t",this_ValidAnalyte)) # Print the result.
  }else{
    if (extracted_digits %in% t_allSamplesMetabolites$idNo) { # Check if sample already exists in list 
      t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == extracted_digits,"ExpSet"] <- this_Set
      if (!this_ValidAnalyte == TRUE){  # Update analyte value with CalcConc
        if (this_Analyte == "Cotinine") {                      # set [COT]calc
          cotinineValue <- t_calcConcData[each,"CalcConc"]
          t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == extracted_digits,"COTconc"] = as.numeric(cotinineValue)
        } else if (this_Analyte == "3-Hydroxycotinine") {      # set [3HC]calc
          tHCValue <- t_calcConcData[each,"CalcConc"]
          t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == extracted_digits,"tHCconc"] = as.numeric(tHCValue)
        } else if (this_Analyte == "Nicotine") {               # set [NIC]calc
          nicValue <- t_calcConcData[each,"CalcConc"]
          t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == extracted_digits,"NICconc"] = as.numeric(nicValue)
        } else if (this_Analyte == "Nicotine-1-oxide") {               # set [NO]calc
          noValue <- t_calcConcData[each,"CalcConc"]
          t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == extracted_digits,"NOconc"] = as.numeric(noValue)
        } else if (this_Analyte == "Cotinine-N-oxide") {               # set [CO]calc
          coValue <- t_calcConcData[each,"CalcConc"]
          t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == extracted_digits,"COconc"] = as.numeric(coValue)
        } else if (this_Analyte == "Nornicotine") {               # set [NORN]calc
          nornValue <- t_calcConcData[each,"CalcConc"]
          t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == extracted_digits,"NORNconc"] = as.numeric(nornValue)
        }else{ print("Valid analyte not accounted for")}
      }else{ # if analyte value is false, then set pertinent variable to zero.
        if (this_Analyte == "Cotinine") {                      # set [COT]calc
          t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == extracted_digits,"COTconc"] = 0
        } else if (this_Analyte == "3-Hydroxycotinine") {      # set [3HC]calc
          t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == extracted_digits,"3HCconc"] = 0
        } else if (this_Analyte == "Nicotine") {               # set [NIC]calc
          t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == extracted_digits,"NICconc"] = 0
        } else if (this_Analyte == "Nicotine-1-oxide") {               # set [NO]calc
          t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == extracted_digits,"NOconc"] = 0
        } else if (this_Analyte == "Cotinine-N-oxide") {               # set [CO]calc
          t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == extracted_digits,"COconc"] = 0
        } else if (this_Analyte == "Nornicotine") {               # set [NORN]calc
          t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == extracted_digits,"NORNconc"] = 0
        }else{ print("Valid analyte not accounted for")}
        print("analyte is invalid")}      # or? Update anlayte value with "0"}
    }else{
      #append new line w/ all pertinent details
      print(paste(extracted_digits,"IF",extracted_digits %in% t_allSamplesMetabolites$idNo))
    }
  }
}

for (s in 1:nrow(t_allSamplesMetabolites)) {
  cotConc <- t_allSamplesMetabolites[s,"COTconc"]
  thcConc <- t_allSamplesMetabolites[s,"tHCconc"]
  calculatedNMR <-thcConc/cotConc
  temp_logNMR = log10(calculatedNMR) #logNMR= log(base 10) of calculated NMR value
  tempID <- t_allSamplesMetabolites$idNo[s]
  t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == tempID,"NMRcalc"] = as.numeric(calculatedNMR)
  t_allSamplesMetabolites[t_allSamplesMetabolites$idNo == tempID,"logNMR"] = as.numeric(temp_logNMR)
}
```

## For each sample idNo, add matched raw intake survey data 
Accomplished by left joining "t_allSamplesMetabolites" to "t_rawSurveyData"
```{r addSurveyData}
t_allSamples <- t_allSamplesMetabolites # n=824
#be sure to include non-smoker controls that have NMR=0, set to 0 from na so not excluded in join methods
t_allSamples[t_allSamples$idNo=="103006","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="102041","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="102167","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="103672","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="202748","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="202056","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="202808","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="303153","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="102155","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="202348","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="203304","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="202542","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="202642","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="302971","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="202699","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="102507","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="102192","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="303222","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="102565","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="103388","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="202870","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="302063","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="202978","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="303527","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="302648","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="303139","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="303151","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="103696","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="303127","NMRcalc"] <- as.numeric(0) 
t_allSamples[t_allSamples$idNo=="303013","NMRcalc"] <- as.numeric(0) 

# LEFT-JOIN subsetted raw survey data as columns to sample ID rows
t_validNMRsamples <- left_join(t_allSamples, t_rawSurveyData, by = c("idNo" = "IDNO"))  # Add pertinent data from the raw intake survey data to matching idNo to IDNO
t_otherSurvey_subset <- subset(t_otherSurveyData[,c("IDNO","Category","GENDER","Age.at.Collection","Smoke.More.Than.100.Cigs.P1","Smoking.Duration.Years.P1","Packs.per.Year.P1","Smoke.More.Than.100.Cigs.P2","Smoking.Duration.Years.P2","Packs.per.Year.P2")])
t_beforeExclusions <- left_join(t_validNMRsamples, t_otherSurvey_subset, by = c("idNo" = "IDNO"))

```

## Cleaning the dataframe for analysis: "t_beforeExclusions"
To pull out specific variables, rename them according to the survey phase II data dictionary, and include calculated variables.
### primary key: "idNo"
### primary value: "Smoker_status"
### primary value: "Age_category"
### primary value: "BMI_calc"
### primary value: "BMI_category"
### primary value: "Secondhand_atRisk"
### primary value: "CeremonialOnly"

#### Note: I need to include CDC BMI references in documentation for this script.
```{r dfCleanup}
## add supplementary columns for inferred data
t_beforeExclusions["Smoker_status"] <- ""
t_beforeExclusions["Age_category"] <- ""
t_beforeExclusions["BMI_calc"] <- ""
t_beforeExclusions["BMI_category"] <- ""
t_beforeExclusions["Secondhand_atRisk"] <- ""
t_beforeExclusions["CeremonialOnly"] <-""

### BMI addition ###
#TODO: exlude those without a BMI
# According to CDC, BMI = weight [kg] / (height [m])^2 *10000[cm/m]
calculate_bmi <- function(weight_kg, height_cm) {
  bmi <- weight_kg / (height_cm^2)*10000 # Calculate BMI
  return(bmi) # Return the result
}

for (s in 1:nrow(t_beforeExclusions)) {
  this_height_cm <- t_beforeExclusions[s,"EX2_7"]
  this_weight_kg <- t_beforeExclusions[s,"EX2_8"]
  calcBMI <- calculate_bmi(this_weight_kg,this_height_cm)
  t_beforeExclusions[s,"BMI_calc"]= as.numeric(calcBMI)
}

for (s in 1:nrow(t_beforeExclusions)) {
  this_BMI <- t_beforeExclusions[s,"BMI_calc"]
  if (is.na(this_BMI)) next
  else if (this_BMI < 25.0) { t_beforeExclusions[s,"BMI_category"] <- "Underweight/Healthy"}
  else if (this_BMI >= 25.0 & this_BMI < 30.0 ) { t_beforeExclusions[s,"BMI_category"] <- "Overweight"}
  else if (this_BMI >= 30.0 ) { t_beforeExclusions[s,"BMI_category"] <- "Obese"}
  else {print("Error fitting BMI into categories")}
}

## Determining smoker status
for (s in 1:nrow(t_beforeExclusions)) {
  this_selfDeclared_smokerStatus <- t_beforeExclusions[s,"INT22_4"]
  this_CPD <- t_beforeExclusions[s,"INT22_5"]
#  this_CPYr <- t_beforeExclusions[s,"Smoke.More.Than.100.Cigs.P2"]
  if (any(is.na(this_selfDeclared_smokerStatus))) {
    if (is.na(this_CPD)){
      t_beforeExclusions[s,"Smoker_status"] <- "exclude"
    }else if (this_CPD>0) {
      t_beforeExclusions[s,"Smoker_status"] <- "Smoker"
    } else {t_beforeExclusions[s,"Smoker_status"] <- "Non-smoker"}
  }
  else if (this_selfDeclared_smokerStatus==1) {t_beforeExclusions[s,"Smoker_status"] <- "Smoker"} 
  else if (this_selfDeclared_smokerStatus==2) {
    if (is.na(this_CPD)){
      t_beforeExclusions[s,"Smoker_status"] <- "Non-smoker"
    }else if (this_CPD>0) {
        t_beforeExclusions[s,"Smoker_status"] <- "Smoker"
    } else {t_beforeExclusions[s,"Smoker_status"] <- "Non-smoker"} #this_CPD == 0, this_CPD == 99, ,  this_CPYr=="Never"
  }
}

## Age
excluded_naAge <- data.frame()
mean_age <- mean(t_beforeExclusions[,"Age.at.Collection"], na.rm=TRUE); print(mean_age)
for (s in 1:nrow(t_beforeExclusions)) {
  this_age <- t_beforeExclusions[s,"Age.at.Collection"]; print(this_age)
  this_ageBoolean <- this_age <= mean_age
  if (is.na(this_age)) {excluded_naAge <- rbind(excluded_naAge,s)}
  else if (this_ageBoolean == TRUE) {
    print(this_age)
    t_beforeExclusions[s,"Age_category"] <- "Younger"
    }
  else t_beforeExclusions[s,"Age_category"] <- "Older"
}

```

```{r specExclusions}
# Specific Exclusions
## Exclude samples with no BMI, age, gender, or cpd information since complete data set is needed for analysis
# exclude smokers with na NMR (they all had [3HC]<LLOQ)
excluded_smokers_naNMR <- subset(t_beforeExclusions,t_beforeExclusions[,"Smoker_status"]=="Smoker")
excluded_smokers_naNMR <- subset(excluded_smokers_naNMR,is.na(excluded_smokers_naNMR$NMRcalc))
#exclude non-smoker controls with NMR>0
t_afterExclusions <- subset(t_beforeExclusions, !(t_beforeExclusions$idNo=="202642")) #   824 filtered down to 823
#exclude smokers with incomplete survey data for height, weight, age at time of plasma draw, cpd
excluded_smokers_naBMI <- subset(t_beforeExclusions,is.na(t_beforeExclusions$BMI_calc)) #BW controls + 2 smokers: 103154,103554
excluded_smokers_naAge <- subset(t_beforeExclusions,is.na(t_beforeExclusions$Age.at.Collection)) #only BW control
t_afterExclusions <- subset(t_afterExclusions, !(t_afterExclusions$idNo=="103154"))
t_afterExclusions <- subset(t_afterExclusions, !(t_afterExclusions$idNo=="103554")) #823 filtered down to 821

#TODO add metabolizer categories
t_afterExclusions <- subset(t_afterExclusions, !(t_afterExclusions$idNo=="2720"))
t_afterExclusions <- subset(t_afterExclusions, !(t_afterExclusions$idNo=="3348"))
t_afterExclusions <- subset(t_afterExclusions, !(t_afterExclusions$idNo=="3955"))
t_afterExclusions <- subset(t_afterExclusions, !(t_afterExclusions$idNo=="5829"))
```

## OUTPUT FILES: final, clean NMR dataframe for analysis, list of excluded ids for requesting more plasma to re-run, original, full-sized NMR dataframe


# Output: A list of excluded sample ids to request SHS for more plasma to re-run assay
```{r outputFiles}
allExcluded_list <- left_join(excluded_smokers_naNMR,excluded_smokers_naBMI,by = c("idNo" = "idNo"))
# TODO: join with samples on my rerun list .xlsx
write.csv(allExcluded_list, file = "listIDs_excludedSHSph2_04082024CRM.csv", row.names = TRUE)
print("Successfully output allExcluded_list")
# Output: A list of combined results for all 824 samples
write.csv(t_beforeExclusions, file = "allNMRassayResults_04082024CRM.csv", row.names = TRUE)
print("Successfully output t_beforeExclusions")
# Output: A list of smokers with reliable NMR values/survey data to request DNA samples for sequencing prep
write.csv(df2_forDiplotyping, file = "SHSph2_NMRwithBasicSurvey.csv", row.names = TRUE)
print("Successfully output SHSph2_NMRwithBasicSurvey.csv")
df <- t_afterExclusions 
write.csv(df, file = "SHSph2_NMRwithBasicSurvey.csv", row.names = TRUE)
print("Successfully output df")
```

